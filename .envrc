#!/usr/bin/env bash
# Pi-Sat direnv configuration
# KISS: Only venv activation + PYTHONPATH. All app config lives in config.py

# Get project root
export PROJECT_ROOT="$(expand_path .)"

# Ensure user-level tools are available inside direnv shells
PATH_add "$HOME/.local/bin"
PATH_add "$HOME/.npm-global/bin"

# Activate Python virtual environment
if [ -d "$PROJECT_ROOT/venv" ]; then
    source "$PROJECT_ROOT/venv/bin/activate"
    printf '%s\n' "Activated Python venv"
else
    # Keep direnv working even before install; avoid relying on non-portable log helpers.
    printf '%s\n' "Virtual environment not found. Run: ./pi-sat.sh install"
fi

# Add project to PYTHONPATH for imports
export PYTHONPATH="$PROJECT_ROOT:$PROJECT_ROOT/hailo_examples/speech_recognition:${PYTHONPATH:-}"

# Unbuffered Python output (useful for debugging)
export PYTHONUNBUFFERED=1

# Load local overrides (optional, for machine-specific settings)
# Example .envrc.local:
#   export HAILO_STT_LANGUAGE='en'  # Override default French
#   export PISAT_DEBUG=true          # Enable debug mode
if [ -f "$PROJECT_ROOT/.envrc.local" ]; then
    source_env "$PROJECT_ROOT/.envrc.local"
fi

# Bash completion (direnv can export env vars + functions, not `complete` directly).
# Install once on the next prompt when entering this repo (bash only).
if [ -n "${BASH_VERSION:-}" ]; then
    __pisat_direnv_install_completion() {
        local completion="$PROJECT_ROOT/pi-sat-completion.bash"
        if [ -f "$completion" ]; then
            # shellcheck disable=SC1090
            source "$completion"
        fi

        case ";${PROMPT_COMMAND:-};" in
            *";__pisat_direnv_install_completion;"*)
                PROMPT_COMMAND="${PROMPT_COMMAND/__pisat_direnv_install_completion; /}"
                PROMPT_COMMAND="${PROMPT_COMMAND/__pisat_direnv_install_completion/}"
                ;;
        esac

        unset -f __pisat_direnv_install_completion 2>/dev/null || true
    }
    export -f __pisat_direnv_install_completion

    case ";${PROMPT_COMMAND:-};" in
        *";__pisat_direnv_install_completion;"*) ;;
        *) PROMPT_COMMAND="__pisat_direnv_install_completion; ${PROMPT_COMMAND:-}" ;;
    esac
fi
